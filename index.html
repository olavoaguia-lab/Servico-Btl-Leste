<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Serviço Ordinário - Batalhão Leste</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* --- Variáveis de Cor Otimizadas para a Identidade Visual do Batalhão --- */
        :root {
            --batalhao-azul-escuro: #1A4384; /* Borda do logo / textos importantes */
            --batalhao-azul-claro: #2C509B; /* Céu do logo / fundo de cards e gráficos */
            --batalhao-verde: #4C7C4C;    /* Paisagem do logo / elementos de sucesso */
            --batalhao-amarelo: #FFD700;  /* Sol do logo / elementos de destaque */
            --batalhao-laranja: #FFA000;  /* Alternativa para destaque/aviso */
            --batalhao-vermelho: #D32F2F; /* Para alertas de perigo/faltas */
            --batalhao-branco: #F5F5F5;   /* Textos e detalhes claros */
            --batalhao-preto-transparente: rgba(0, 0, 0, 0.4); /* Fundo de controles/sombras */

            --shadow-powerbi: 0 4px 8px rgba(0, 0, 0, 0.2); /* Sombra mais pronunciada */
            --border-radius-lg: 12px;
            --border-radius-md: 8px;
        }

        /* --- Estilos Globais e Reset --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body {
            background-color: var(--batalhao-azul-escuro); /* Fundo sólido ou gradiente sutil */
            color: var(--batalhao-branco);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinha o conteúdo ao topo */
        }

        .dashboard-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }

        /* --- Header (Título e Logo) --- */
        .header {
            grid-column: 1 / -1;
            background-color: var(--batalhao-azul-claro);
            padding: 15px 25px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-powerbi);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px; /* Espaço entre elementos do header */
        }
        .header h2 {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--batalhao-branco);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header .logo-container {
            height: 60px; /* Tamanho do logo */
            width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header .logo-container img {
            max-height: 100%;
            max-width: 100%;
            border-radius: 50%; /* Se o logo for circular, ajuda a garantir o formato */
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }
        .header .date-time {
            text-align: right;
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* --- Controles (Upload e Filtros) --- */
        .controls {
            grid-column: 1 / -1;
            background-color: var(--batalhao-preto-transparente); /* Fundo escuro transparente */
            padding: 15px 25px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-powerbi);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-items: center;
        }
        .control-group label { margin-right: 10px; font-weight: 400; color: var(--batalhao-branco); }
        .control-group select, .control-group input[type="file"], .upload-btn {
            padding: 10px 15px;
            border-radius: var(--border-radius-md);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--batalhao-branco);
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.2s ease-in-out;
        }
        .control-group select:focus, .control-group input[type="file"]:focus, .upload-btn:focus {
            outline: none;
            border-color: var(--batalhao-amarelo);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
        }
        .upload-btn { 
            background-color: var(--batalhao-amarelo); 
            color: var(--batalhao-azul-escuro); 
            font-weight: 600;
            border-color: var(--batalhao-amarelo);
        }
        .upload-btn:hover {
            background-color: #e6c200; /* Um pouco mais escuro */
            box-shadow: var(--shadow-powerbi);
        }
        #csv-file-input { display: none; }

        /* --- Grid de Cards de Estatísticas --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Cards um pouco maiores */
            gap: 20px;
        }

        .card {
            background-color: var(--batalhao-azul-claro); /* Fundo dos cards */
            padding: 25px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-powerbi);
            backdrop-filter: blur(5px);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border-left: 5px solid; /* Borda colorida para identificação */
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        .card h3 { 
            font-size: 1.15em; 
            margin-bottom: 15px; 
            color: var(--batalhao-branco); /* Títulos brancos */
            opacity: 0.9;
        }
        .card .value { 
            font-size: 2.8em; /* Valor maior */
            font-weight: 700; 
            color: var(--batalhao-amarelo); /* Destaque em amarelo */
            line-height: 1;
        }

        /* Cores das bordas dos Cards */
        #efetivo-total-previsto { border-left-color: var(--batalhao-azul-escuro); }
        #efetivo-total-previsto .value { color: var(--batalhao-branco); } /* Previsto fica branco */
        #efetivo-presente-dia { border-left-color: var(--batalhao-verde); }
        #efetivo-presente-dia .value { color: var(--batalhao-verde); } /* Presente verde */
        #efetivo-ausente-dia { border-left-color: var(--batalhao-vermelho); }
        #efetivo-ausente-dia .value { color: var(--batalhao-vermelho); } /* Ausente vermelho */
        #total-viaturas-servico { border-left-color: var(--batalhao-amarelo); }
        #total-viaturas-servico .value { color: var(--batalhao-amarelo); } /* VTRs amarelo */

        /* --- Seção de Gráficos e Tabelas --- */
        .chart-section {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); /* Gráficos um pouco maiores */
            gap: 20px;
        }

        .chart-container {
            min-height: 380px; /* Altura um pouco maior para gráficos */
            background-color: var(--batalhao-azul-claro); /* Fundo dos gráficos */
            padding: 25px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-powerbi);
            display: flex;
            flex-direction: column;
        }
        .chart-container h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: var(--batalhao-branco);
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0.9;
        }
        .chart-container > div {
            flex-grow: 1; /* Faz o canvas preencher o espaço restante */
            min-height: 0; /* Permite que o flex-grow funcione corretamente */
        }
        canvas {
            max-height: 100%; /* Garante que o canvas não estoure */
            width: 100%;
        }

        /* --- Estilos de Tabela --- */
        .data-table {
            width: 100%;
            border-collapse: separate; /* Para bordas arredondadas */
            border-spacing: 0;
            color: var(--batalhao-branco);
            font-size: 0.9em;
            border-radius: var(--border-radius-md);
            overflow: hidden; /* Garante que as bordas arredondadas sejam aplicadas */
        }
        .data-table thead tr { 
            background-color: rgba(255, 255, 255, 0.15); /* Cabeçalho mais claro */
            font-weight: 600;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08); /* Linhas mais sutis */
        }
        .data-table tbody tr:hover { 
            background-color: rgba(255, 255, 255, 0.08); 
        }
        .data-table tbody tr:last-child td {
            border-bottom: none; /* Remove a borda da última linha */
        }
        .data-table .status-presente { color: var(--batalhao-verde); font-weight: bold; }
        .data-table .status-afastado, .data-table .status-ferias { color: var(--batalhao-laranja); font-weight: bold; }
        .data-table .status-falta, .data-table .status-nao-informado { color: var(--batalhao-vermelho); font-weight: bold; }


        /* --- Responsividade --- */
        @media (min-width: 768px) {
            .chart-section { 
                grid-template-columns: repeat(3, 1fr); 
            }
            #tabela-detalhada-efetivo-container {
                grid-column: span 2;
            }
            #top-locais-chart-container {
                grid-column: span 1;
            }
        }
        @media (max-width: 767px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            .header .date-time {
                text-align: center;
                margin-top: 10px;
            }
            .header h2 {
                flex-direction: column;
                text-align: center;
                font-size: 1.5em;
            }
            .controls {
                justify-content: center;
            }
        }

        /* --- Overlay de Carregamento e Alertas --- */
        #loading-overlay {
            background: rgba(0,0,0,0.8);
        }
        .spinner {
            border-top: 6px solid var(--batalhao-amarelo);
        }
        #alert-message {
            background-color: var(--batalhao-verde); /* Cor padrão de sucesso */
            box-shadow: var(--shadow-powerbi);
        }
        #alert-message.error {
            background-color: var(--batalhao-vermelho);
        }
    </style>
</head>
<body>

    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000;">
        <div class="spinner" style="border: 6px solid rgba(255, 255, 255, 0.3); border-top: 6px solid var(--batalhao-amarelo); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    </div>
    <div id="alert-message" style="display: none; position: fixed; top: 10px; right: 10px; padding: 10px 20px; border-radius: 5px; color: white; z-index: 1001; transition: opacity 0.3s;"></div>
    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

    <div class="dashboard-container">

        <header class="header">
            <div class="logo-container">
                </div>
            <h2>Serviço Ordinário - Batalhão Leste <i class="fas fa-chart-line"></i></h2>
            <div class="date-time">
                <span id="current-date"></span><br>
                <span id="current-time" style="font-size: 0.9em;"></span>
            </div>
        </header>

        <div class="controls">
            <div class="control-group">
                <button id="upload-btn" class="upload-btn"><i class="fas fa-upload"></i> Carregar Dados (.xlsx/.csv)</button>
                <input type="file" id="csv-file-input" accept=".xlsx, .xls, .csv">
            </div>

            <div class="control-group">
                <label for="unidade-select">Unidade (Btl/Cicom):</label>
                <select id="unidade-select">
                    <option value="todas">Todas as Unidades</option>
                </select>
            </div>
            
            <span style="font-weight: 500; opacity: 0.8; align-self: center;">Dados Referentes ao Arquivo Carregado.</span>
        </div>
        
        <div class="stats-grid">
            <div class="card" id="efetivo-total-previsto">
                <h3>Efetivo Total (Previsto)</h3>
                <p class="value" id="total-previsto">0</p>
            </div>
            <div class="card" id="efetivo-presente-dia">
                <h3>Efetivo Ativo (Presente)</h3>
                <p class="value" id="efetivo-presente-dia-card">0</p>
            </div>
            <div class="card" id="efetivo-ausente-dia">
                <h3>Total de Ausências/Faltas</h3>
                <p class="value" id="efetivo-ausente-dia-card">0</p>
            </div>
            <div class="card" id="total-viaturas-servico">
                <h3>Total de VTRs em Serviço</h3>
                <p class="value" id="vtr-servico">0</p>
            </div>
        </div>

        <div class="chart-section">
            
            <div class="chart-container" id="efetivo-chart-container">
                <h3>Distribuição Efetivo (Ativo vs. Ausente) <i class="fas fa-chart-pie"></i></h3>
                <div style="height: 100%; width: 100%;">
                    <canvas id="efetivoChart"></canvas>
                </div>
            </div>

            <div class="chart-container" id="graduacao-chart-container">
                <h3>Efetivo Ativo por Graduação <i class="fas fa-medal"></i></h3>
                <div style="height: 100%; width: 100%;">
                    <canvas id="graduacaoChart"></canvas>
                </div>
            </div>

            <div class="chart-container" id="top-locais-chart-container">
                <h3>Top Locais/Setores de Atuação <i class="fas fa-map-marker-alt"></i></h3>
                <div style="height: 100%; width: 100%;">
                    <canvas id="topLocaisChart"></canvas>
                </div>
            </div>
            
             <div class="chart-container" id="tabela-detalhada-efetivo-container">
                <h3>Detalhamento do Efetivo (Por Militar) <i class="fas fa-clipboard-list"></i></h3>
                <div id="tabela-detalhada-efetivo" style="flex-grow: 1; overflow-y: auto; ">
                    <p style="text-align: center; margin-top: 50px; opacity: 0.7;">Carregue os dados para visualizar.</p>
                </div>
            </div>

        </div>

    </div>

    <script>
        // --- VARIÁVEIS GLOBAIS ---
        let rawData = []; 
        let currentFilters = {
            unidade: 'todas'
        };
        
        // --- Funções de Injeção de Imagens e SVGs (Para Logos) ---
        // Funções para injetar o logo como SVG ou Base64 (melhor para cores e qualidade)
        function injectLogo(selector) {
            const logoBase64 = "data:image/png;base64,iVBORORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJ/FOxAAAAkFBMVEUAAAD/AAD/Dg7/ExP/DQ3/CAj/Bgf/AQH/FBX/Cwv/AgL/EBD/HR3/Fxf/GRn/GxtmZmZCQkKioqKgoKDj4+Pm5ubk5OTd3d3a2tre3t7Z2dna2tre3t7c3NzR0dHV1dXGxsbBwcHk5OTZ2dnj4+Pq6urp6enl5eXr6+vw8PDx8fHy8vL09PT19fX4+Pj8/Pz9/f3+//+2/c2UAAAAPnRSTlMAYF9hcnNzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3NzdjJ12AAAAAWJLR0QAiAUdSAAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SUhBTQoAAADsFAFAAACUSUlEQVR42u3dC1+cPBfG8WsQQyZJJ5G0UUpZ2i67y0072+30/f+/cW2LzQhXkYtL5Pgeiufp4JzD8Z73/PPei3JcCAAAgC2Q/f14fXz8t/P77P789u72w/H+mI9j/c7z9+/z8/v0eHw+Pj9/n5+/z4/z4+3z+fz8/f17fv0+3w9fX1/+e31+/n7Pz8/P/z9//j8/L35fX38Pj9/X17fX+7t8fF6fP1+f319fX+7v97fD6/39/fX9ff39e/39+/P79/Xh+/L1+Xy/X19eX+/X7+X3+3z8Pr2/3t+3Xz+/v7++v9/f1+/v39f37+Pv38/f37+/f1+3z8/v19/L5fXz8/v18f1+/v7++f//+/v38/f37+/v7++fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5+
