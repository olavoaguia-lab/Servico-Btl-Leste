<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Operacional - Batalh√£o Leste</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* Nova Paleta de Cores Baseada no Bras√£o BTL Leste */
    :root{
      --btl-azul-escuro: #003366; /* Azul Escuro Original */
      --btl-azul-header: #2B5AA0; /* Azul S√≥lido Inspirado no Bras√£o */
      --btl-azul-medio: #0073CF;
      --btl-azul-claro: #7EC8E3;
      --btl-amarelo: #FFC300; /* Cor para 'Limpar Dados' */
      --btl-verde: #1D6A2E; /* Cor para 'Exportar' */
      --btl-vermelho: #C62828;
      --bg-gradient: radial-gradient(circle at 70% 70%, var(--btl-azul-claro) 0%, #e3f2fd 50%, #f3e5f5 100%);
      --card-bg: #fff;
      --text-primary: #1f2933;
      --text-secondary: #6b7b8b;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-md: 0 6px 18px rgba(0,0,0,0.12);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.18);
      --touch-size: 44px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg-gradient);
      color:var(--text-primary);
      -webkit-font-smoothing:antialiased;
    }

    /* HEADER */
    .header{
      background:var(--btl-azul-header); /* Cor s√≥lida #2B5AA0 */
      color:#fff;
      padding:16px 20px;
      position:sticky;
      top:0;
      z-index:120;
      box-shadow:var(--shadow-lg);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .header-left{display:flex;align-items:center;gap:12px}
    .logo-container{
      width:64px;height:64px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      /* Novo gradiente inspirado no bras√£o: amarelo, laranja, verde */
      background: radial-gradient(circle at 30% 30%, var(--btl-amarelo) 0, #FF8C00 35%, var(--btl-verde) 100%);
      border:2px solid rgba(255,255,255,0.7); box-shadow:0 6px 12px rgba(0,0,0,0.35);
    }
    .logo-icon{ font-size:30px;color:#fff; }
    .header-text{ display:flex;flex-direction:column; }
    .header h1{ font-size:1.15rem; font-weight:700;
      letter-spacing:0.02em; }
    .header-subtitle{ font-size:0.82rem; opacity:0.95; margin-top:3px }

    /* header actions */
    .header-actions{ display:flex;
      gap:8px; align-items:center }
    .btn{ display:inline-flex; align-items:center; gap:8px; border-radius:999px; padding:8px 14px; font-weight:700; font-size:0.92rem; cursor:pointer; border:none; box-shadow:var(--shadow-sm);
    }
    .btn:active{ transform:translateY(1px) }
    /* Bot√£o 'Carregar Planilha' com estilo secund√°rio */
    .file-label{ cursor:pointer; display:inline-flex; align-items:center; gap:8px; padding:8px 14px; border-radius:999px; background:rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.18);
      font-weight:700 }
    /* Bot√£o 'Exportar Efetivo' com cor verde tem√°tica */
    .btn-success{ background:var(--btl-verde); color:#fff }
    /* Bot√£o 'Limpar Dados' com cor amarela tem√°tica */
    .btn-warning{ background:var(--btl-amarelo); color:var(--btl-azul-escuro); font-weight:900 }
    
    /* small-screen hamburger - REMOVIDO */
    .hamburger{ display:none; }

    .container{ max-width:1400px; margin:18px auto;
      padding:0 18px; }

    /* METRICS */
    .metrics-grid{
      display:grid;
      /* Responsivo: 2 colunas em telas m√©dias, 1 coluna em telas pequenas */
      grid-template-columns: repeat( auto-fit, minmax(210px, 1fr) );
      gap:14px;
      margin-bottom:18px;
    }
    .metric-card{
      background:var(--card-bg); border-radius:12px;
      padding:14px; box-shadow:var(--shadow-md);
      display:flex; flex-direction:column; gap:8px;
      border-left:5px solid transparent; transition:transform .18s ease, box-shadow .18s ease;
    }
    .metric-card:hover{ transform:translateY(-3px);
      box-shadow:var(--shadow-lg) }
    .metric-header{ display:flex; justify-content:space-between; align-items:flex-start }
    .metric-label{ font-size:0.78rem; color:var(--text-secondary); font-weight:800; text-transform:uppercase;
      letter-spacing:0.06em }
    .metric-subtitle{ font-size:0.78rem; color:var(--text-secondary); margin-top:4px; font-weight:600 }
    .metric-value{ font-size:1.9rem; font-weight:900;
      color:var(--btl-azul-escuro) }

    .metric-icon{ width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#fff;
    }
    .metric-efetivo{ border-color:var(--btl-azul-medio) }
    .metric-efetivo .metric-icon{ background:linear-gradient(135deg,var(--btl-azul-medio),var(--btl-azul-claro)) }
    .metric-faltas{ border-color:var(--btl-vermelho) }
    .metric-faltas .metric-icon{ background:linear-gradient(135deg,#C62828,#FF7043) }
    .metric-presente{ border-color:var(--btl-verde) }
    .metric-presente .metric-icon{ background:linear-gradient(135deg,var(--btl-verde),#4CAF50) }
    .metric-viaturas{ border-color:var(--btl-amarelo) } /* Cor ajustada */
    .metric-viaturas .metric-icon{ background:linear-gradient(135deg,var(--btl-amarelo),#FFA000) }

    /* layout principal - Modificado para 100% vertical no mobile */
    .main-layout{ 
      display:grid; 
      grid-template-columns: 1fr; /* For√ßando layout 100% vertical */
      gap:18px; align-items:start 
    }

    /* sidebar - Sempre vis√≠vel no topo (primeiro elemento) */
    .sidebar{ 
      background:var(--card-bg); padding:14px; border-radius:12px; box-shadow:var(--shadow-md);
      position:static; /* Remove sticky */
      top:auto; height:fit-content;
    }
    .sidebar-header{ display:flex; align-items:center; gap:10px; margin-bottom:10px;
      font-weight:900 }
    .filter-group{ margin-bottom:12px }
    .filter-group label{ display:block; font-weight:700; margin-bottom:6px;
      font-size:0.9rem }
    .filter-group select{ width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e8e8e8; font-size:0.9rem;
      background:#fafafa }

    .btn-reset{ width:100%; padding:10px; border-radius:10px; background:#f3f3f3;
      font-weight:800 }

    /* charts grid - Adaptado para 1 coluna no mobile */
    .charts-grid{ display:grid; grid-template-columns: 1fr; /* For√ßando 1 coluna */
      gap:16px;
      margin-bottom:18px }
    .chart-card{ background:var(--card-bg); padding:12px; border-radius:12px; box-shadow:var(--shadow-md) }
    .chart-header{ display:flex; justify-content:space-between; align-items:center;
      margin-bottom:10px }
    .chart-title{ font-weight:800; color:var(--btl-azul-escuro) }

    .chart-wrapper{ height:280px; /* Ajuste para melhor visualiza√ß√£o vertical */
      position:relative }

    /* viaturas grid - Adaptado para 2 colunas no mobile */
    .viaturas-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(150px,1fr)); /* M√≠nimo menor para mobile */
      gap:12px;
      margin-top:8px }
    .viatura-card{ padding:10px; border-radius:10px; color:#fff; text-align:center;
      box-shadow:var(--shadow-md) }

    /* table */
    .table-card{ background:var(--card-bg); padding:12px; border-radius:12px;
      box-shadow:var(--shadow-md) }
    .table-wrapper{ overflow-x:auto; /* Scroll horizontal apenas quando necess√°rio */
      max-height:520px; margin-top:8px }
    .data-table{ min-width:600px; /* Garante scroll horizontal em telas estreitas */
      width:100%; border-collapse:collapse;
      font-size:0.92rem }
    .data-table thead{ position:sticky; top:0; background:var(--btl-azul-escuro); color:#fff;
      z-index:10 }
    .data-table th, .data-table td{ padding:10px 12px; border-bottom:1px solid #f0f0f0;
      text-align:left }
    .status-badge{ padding:6px 10px; border-radius:999px; font-weight:800;
      font-size:0.78rem }

    /* loading & alerts */
    .loading-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center;
      z-index:1000 }
    .loading-overlay.active{ display:flex }
    .spinner{ width:56px;height:56px;border-radius:50%;border:6px solid rgba(255,255,255,0.14); border-top-color:#fff;
      animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .alert-container{ position:fixed; top:88px;
      right:18px; z-index:150; max-width:320px }
    .alert{ padding:10px 12px; border-radius:10px; color:#fff;
      font-weight:800 }

    /* Responsividade */
    @media(min-width:768px){ /* Tablet e Desktop */
      .metrics-grid{
        grid-template-columns: repeat( auto-fit, minmax(180px, 1fr) ); /* 4 colunas em telas maiores */
      }
      .charts-grid{ 
        grid-template-columns: repeat(auto-fit,minmax(350px,1fr)); /* 2 colunas em telas maiores */
      }
      .viaturas-grid{ grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); }
      .sidebar{ position:sticky; top:92px; height:fit-content } /* Mant√©m filtros sticky no desktop */
      .main-layout{ grid-template-columns: 270px 1fr; } /* Layout original para desktop/tablet */
    }

    @media(max-width:767px){ /* Mobile */
      .header{ padding:12px 10px; flex-wrap:wrap; }
      .header-left{ width:100%; justify-content:center; }
      .header-actions{ width:100%; justify-content:center; gap:8px; margin-top:8px; }
      .file-label, .btn{ padding:8px 10px; font-size:0.86rem; }
      .logo-container{ width:56px;height:56px }
      .header h1{ font-size:1rem }
      .metric-value{ font-size:1.6rem; }
      /* Sidebar for√ßado a 100% de largura no topo em mobile */
      .sidebar{ order:1; }
      .section{ order:2; }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
  <div class="alert-container" id="alertContainer"></div>

  <header class="header" role="banner">
    <div class="header-left">
      <div class="logo-container" aria-hidden="true">
        <i class="fas fa-chart-line logo-icon" title="An√°lise Operacional"></i>
      </div>
      <div class="header-text">
        <h1>Dashboard Operacional - Batalh√£o Leste</h1>
        <div class="header-subtitle" id="updateTime">‚Äî</div>
      </div>
    </div>

    <div class="header-actions" role="toolbar" aria-label="A√ß√µes">
      <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" style="display:none" />
      <label class="file-label" for="fileInput"><i class="fas fa-file-upload"></i> Carregar Planilha</label>

      <button class="btn btn-success" id="exportBtn" onclick="exportar()">
        <i class="fas fa-download"></i> Exportar Efetivo
      </button>

      <button class="btn btn-warning" onclick="clearData()">
        <i class="fas fa-trash-alt"></i> Limpar Dados
      </button>
    </div>
  </header>

  <main class="container" role="main">
    <div class="metrics-grid" aria-live="polite">
      <div class="metric-card metric-efetivo" id="cardEfetivo">
        <div class="metric-header">
          <div>
            <div class="metric-label">Efetivo Total</div>
            <div class="metric-subtitle">Total de policiais no Batalh√£o</div>
          </div>
          <div class="metric-icon"><i class="fas fa-users"></i></div>
        </div>
        <div class="metric-value" id="efetivoTotal">0</div>
      </div>

      <div class="metric-card metric-faltas">
        <div class="metric-header">
          <div>
            <div class="metric-label">Faltas ao Servi√ßo</div>
            <div class="metric-subtitle">Aus√™ncias n√£o justificadas</div>
          </div>
          <div class="metric-icon"><i class="fas fa-exclamation-triangle"></i></div>
        </div>
        <div class="metric-value" id="totalFaltas">0</div>
      </div>

      <div class="metric-card metric-presente">
        <div class="metric-header">
          <div>
            <div class="metric-label">Efetivo Presente</div>
            <div class="metric-subtitle">Policiais em servi√ßo / guarni√ß√£o</div>
          </div>
          <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
        </div>
        <div class="metric-value" id="efetivoPresente">0</div>
      </div>

      <div class="metric-card metric-viaturas">
        <div class="metric-header">
          <div>
            <div class="metric-label">Total de Viaturas</div>
            <div class="metric-subtitle">Viaturas montadas em servi√ßo</div>
          </div>
          <div class="metric-icon"><i class="fas fa-car"></i></div>
        </div>
        <div class="metric-value" id="totalViaturas">0</div>
      </div>
    </div>

    <div class="main-layout">
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><i class="fas fa-filter"></i> <strong>Filtros de An√°lise</strong></div>
        <div class="filter-group"><label for="unidadeFilter">Filtrar por OPM:</label><select id="unidadeFilter" onchange="filterDashboard()"><option value="">Todas as OPMs</option></select></div>
        <div class="filter-group"><label for="graduacaoFilter">Filtrar por Gradua√ß√£o:</label><select id="graduacaoFilter" onchange="filterDashboard()"><option value="">Todas as Gradua√ß√µes</option></select></div>
        <div class="filter-group"><label for="localFilter">Filtrar por Local:</label><select id="localFilter" onchange="filterDashboard()"><option value="">Todos os Locais</option></select></div>
        <div class="filter-group"><label for="funcaoFilter">Filtrar por Fun√ß√£o:</label><select id="funcaoFilter" onchange="filterDashboard()"><option value="">Todas as Fun√ß√µes</option></select></div>
        <div class="filter-group"><label for="viaturaFilter">Filtrar por Viatura:</label><select id="viaturaFilter" onchange="filterDashboard()"><option value="">Todas as Viaturas</option></select></div>
        <button class="btn-reset" onclick="resetFilters()"><i class="fas fa-redo"></i> Limpar Filtros</button>
      </aside>

      <section>
        <div class="charts-grid">
          <div class="chart-card"><div class="chart-header"><div class="chart-title"><i class="fas fa-shield-alt"></i> Efetivo por OPM</div></div><div class="chart-wrapper"><canvas id="unidadeChart"></canvas></div></div>

          <div class="chart-card"><div class="chart-header"><div class="chart-title"><i class="fas fa-user-tag"></i> Status do Efetivo</div></div><div class="chart-wrapper"><canvas id="statusChart"></canvas></div></div>

          <div class="chart-card"><div class="chart-header"><div class="chart-title"><i class="fas fa-star"></i> Distribui√ß√£o por Gradua√ß√£o</div></div><div class="chart-wrapper"><canvas id="graduacaoChart"></canvas></div></div>

          <div class="chart-card"><div class="chart-header"><div class="chart-title"><i class="fas fa-exclamation-circle"></i> An√°lise de Faltas</div></div><div class="chart-wrapper"><canvas id="faltasChart"></canvas></div></div>

          </div>

        <div class="chart-card">
          <div class="chart-header"><div class="chart-title"><i class="fas fa-car"></i> Distribui√ß√£o de Viaturas</div>
            <div><label for="topViaturasSelector" style="font-weight:700;margin-right:6px">TOP</label><select id="topViaturasSelector" onchange="updateViaturasDisplay()"><option value="8">8</option><option value="12">12</option><option value="5">5</option><option value="999">Todas</option></select></div>
          </div>
          <div class="viaturas-grid" id="viaturasGrid"></div>
        </div>

        <div class="table-card" style="margin-top:14px">
          <div class="chart-header"><div class="chart-title"><i class="fas fa-table"></i> Detalhamento do Efetivo</div></div>
          <div class="table-wrapper">
            <table class="data-table" id="detalhesTable">
              <thead>
                <tr><th>OPM</th><th>Posto/Grad</th><th>Nome de Guerra</th><th>Fun√ß√£o</th><th>Viatura</th><th>Local de Atua√ß√£o</th><th>Status</th></tr>
              </thead>
              <tbody id="detalhesTableBody"><tr><td colspan="7" style="text-align:center;padding:40px;color:#7f8c8d">Carregue uma planilha para visualizar os dados.</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ---------- Globais (N√£o Alterado) ----------
    let fullData = [];
    let charts = {};
    let validUnits = new Set(), validGraduacoes = new Set(), validLocais = new Set(), validFuncoes = new Set(), validViaturas = new Set();
    const COLUMN_MAP = {
      unidade: 'UNIDADE',
      prefixo: 'PREFIXO',
      funcao: 'FUN√á√ÉO',
      graduacao: 'POSTO/GRAD',
      nome: 'NOME DE GUERRA',
      identidade: 'IDENTIDADE',
      local: 'LOCAL DE ATUA√á√ÉO',
      status: 'STATUS DO EFETIVO'
    };
    // ---------- Utilidades (N√£o Alterado) ----------
    function showLoading(show){
      document.getElementById('loadingOverlay').classList.toggle('active', !!show);
    }
    function showAlert(msg, type='success'){
      const c = document.getElementById('alertContainer');
      const d = document.createElement('div');
      d.className = 'alert';
      d.style.background = (type==='error') ? 'var(--btl-vermelho)' : '#1b5e20';
      d.textContent = msg;
      c.appendChild(d);
      setTimeout(()=>{ d.style.opacity = '0'; d.style.transform = 'translateX(40px)'; d.addEventListener('transitionend', ()=>d.remove()) }, 4200);
    }
    function updateDateTime(){
      const now = new Date();
      const dateStr = now.toLocaleDateString('pt-BR',{day:'2-digit',month:'long',year:'numeric'});
      const timeStr = now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
      document.getElementById('updateTime').textContent = `Atualizado: ${dateStr} ‚Ä¢ ${timeStr}`;
    }
    function fixEncoding(s){
      if(!s && s!==0) return s;
      let str = String(s);
      const map = {
        '√É¬°':'√°','√É¬©':'√©','√É¬≠':'√≠','√É¬≥':'√≥','√É¬∫':'√∫','√É¬ß':'√ß','√É¬£':'√£','√É¬µ':'√µ',
        '√É¬™':'√™','√É¬¥':'√¥','√É‚Ä∞':'√â','√¢‚Ç¨‚Ñ¢':"'",'√¢‚Ç¨‚Äú':'-','√¢‚Ç¨‚Äù':'‚Äî',
        '√É≈°':'√ö','√É ': '√Å','√É¬™':'√™','√Ç¬∫':'¬∫','√Ç¬™':'¬™'
      };
      Object.keys(map).forEach(k => { str = str.split(k).join(map[k]); });
      str = str.replace(/\uFFFD/g,'');
      str = str.replace(/\s+/g,' ').trim();
      str = str.replace(/√É/g, '');
      str = str.replace(/\b([0-9]+)\s*e\b/gi, '$1¬™');
      return str;
    }
    function normalizeKey(k){
      return fixEncoding(k || '').trim();
    }
    function findColumn(row, key){
      const normalizedKey = String(key).toLowerCase().replace(/\s+/g,'').replace(/\W/g,'');
      for(const col in row){
        const nc = String(col).toLowerCase().replace(/\s+/g,'').replace(/\W/g,'');
        if(nc === normalizedKey) return row[col];
      }
      return '';
    }
    function normalizeStatus(value){
      if(!value) return 'INDETERMINADO';
      const v = String(value).toUpperCase();
      if(v.includes('PRESEN')) return 'PRESENTE';
      if(v.includes('F√âRIAS')||v.includes('FERIAS')) return 'DE F√âRIAS';
      if(v.includes('AFAST')) return 'AFASTADO';
      if(v.includes('LICEN')) return 'LICEN√áA';
      if(v.includes('DISPENS')) return 'DISPENSADO';
      if(v.includes('FALTA')||v.includes('AUSENTE')) return 'FALTA';
      return 'OUTROS';
    }
    // --------- Processamento da planilha (N√£o Alterado) ----------
    function processExcelData(jsonData){
      showLoading(true);
      fullData = []; validUnits = new Set(); validGraduacoes = new Set(); validLocais = new Set(); validFuncoes = new Set();
      validViaturas = new Set();
      try{
        jsonData.forEach(row=>{
          let unidade = findColumn(row, COLUMN_MAP.unidade);
          let prefixo = findColumn(row, COLUMN_MAP.prefixo);
          let funcao = findColumn(row, COLUMN_MAP.funcao);
          let graduacao = findColumn(row, COLUMN_MAP.graduacao);
          let nome = findColumn(row, COLUMN_MAP.nome);
          let identidade = findColumn(row, COLUMN_MAP.identidade);
          let local = findColumn(row, COLUMN_MAP.local);
          let statusRaw = findColumn(row, COLUMN_MAP.status);

          // aplicar corre√ß√£o de encoding em campos textuais
          unidade = normalizeKey(unidade);
          prefixo = normalizeKey(prefixo);
          funcao = normalizeKey(funcao);
          graduacao = normalizeKey(graduacao);
          nome = normalizeKey(nome);
          identidade = normalizeKey(identidade);
          local = normalizeKey(local);
          const status = normalizeStatus(statusRaw);

          if(unidade && nome){
            fullData.push({
              unidade, prefixo, funcao, graduacao, nome, identidade, local, status,
              presente: status === 'PRESENTE' ? 1 : 0,
              ausente: status !== 'PRESENTE' ? 1 : 0,
              falta: status === 'FALTA' ? 1 : 0
            });
          }

          if(unidade) validUnits.add(unidade);
          if(graduacao) validGraduacoes.add(graduacao);
          if(local) validLocais.add(local);
          if(funcao) validFuncoes.add(funcao);
          if(prefixo) validViaturas.add(prefixo);
        });

        if(fullData.length === 0) throw new Error('Nenhum registro v√°lido encontrado. Verifique as colunas UNIDADE e NOME DE GUERRA.');
        updateFilters();
        filterDashboard();
        showAlert(`‚úÖ ${fullData.length} registros processados.`, 'success');
      }catch(err){
        console.error(err);
        showAlert('Erro ao processar planilha: ' + (err.message||err), 'error');
      }finally{ showLoading(false);
      }
    }
    // ---------- Exporta√ß√£o (N√£o Alterado) ----------
    function exportar(){
      if(!fullData || fullData.length===0){ showAlert('‚ö†Ô∏è Nenhum dado para exportar.', 'error');
      return; }

      const efetivoSheet = fullData.map(r=>({
        UNIDADE: r.unidade||'', PREFIXO: r.prefixo||'', FUNCAO: r.funcao||'', GRADUACAO: r.graduacao||'',
        NOME_DE_GUERRA: r.nome||'', IDENTIDADE: r.identidade||'', LOCAL_DE_ATUACAO: r.local||'', STATUS: r.status||'',
        PRESENTE: r.presente||0, AUSENTE: r.ausente||0, FALTA: r.falta||0
      }));
      const faltasSheet = fullData.filter(r=>r.falta===1).map(r=>({
        UNIDADE: r.unidade||'', PREFIXO: r.prefixo||'', NOME_DE_GUERRA: r.nome||'', GRADUACAO: r.graduacao||'', FUNCAO: r.funcao||'', LOCAL_DE_ATUACAO: r.local||'', STATUS: r.status||'FALTA'
      }));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(efetivoSheet), 'Efetivo_Total');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(faltasSheet.length?faltasSheet:[{INFO:'Nenhuma falta registrada'}]), 'Faltas');

      const fname = `Relatorio_BTL_Leste_${(new Date()).toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fname);
      showAlert('‚¨áÔ∏è Exporta√ß√£o: ' + fname, 'success');
    }
    // ---------- filtros / m√©tricas / tabelas (N√£o Alterado) ----------
    function updateFilters(){
      const map = [
        {id:'unidadeFilter', data: Array.from(validUnits).sort()},
        {id:'graduacaoFilter', data: Array.from(validGraduacoes).sort()},
        {id:'localFilter', data: Array.from(validLocais).sort()},
        {id:'funcaoFilter', data: Array.from(validFuncoes).sort()},
        {id:'viaturaFilter', data: Array.from(validViaturas).sort()}
      ];
      map.forEach(f=>{
        const sel = document.getElementById(f.id);
        if(!sel) return;
        const prev = sel.value;
        sel.innerHTML = `<option value="">Todas</option>`;
        f.data.forEach(item=>{
          const opt = document.createElement('option'); opt.value = item; opt.textContent = item; sel.appendChild(opt);
        });
        if(f.data.includes(prev)) sel.value = prev;
      });
    }
    function resetFilters(){
      ['unidadeFilter','graduacaoFilter','localFilter','funcaoFilter','viaturaFilter'].forEach(id=>{
        const s = document.getElementById(id); if(s) s.value = '';
      });
      filterDashboard();
    }
    function filterDashboard(){
      const unidade = document.getElementById('unidadeFilter').value;
      const graduacao = document.getElementById('graduacaoFilter').value;
      const local = document.getElementById('localFilter').value;
      const funcao = document.getElementById('funcaoFilter').value;
      const viatura = document.getElementById('viaturaFilter').value;
      const filtered = fullData.filter(item=>{
        if(unidade && item.unidade !== unidade) return false;
        if(graduacao && item.graduacao !== graduacao) return false;
        if(local && item.local !== local) return false;
        if(funcao && item.funcao !== funcao) return false;
        if(viatura && item.prefixo !== viatura) return false;
        return true;
      });
      updateMetrics(filtered);
      updateCharts(filtered);
      updateTable(filtered);
      updateViaturasDisplay();
      updateDateTime();
      setTimeout(()=>animateMetrics(),80);
    }
    function updateMetrics(data){
      document.getElementById('efetivoTotal').textContent = data.length;
      document.getElementById('efetivoPresente').textContent = data.filter(d=>d.presente===1).length;
      document.getElementById('totalFaltas').textContent = data.filter(d=>d.falta===1).length;
      document.getElementById('totalViaturas').textContent = [...new Set(data.map(d=>d.prefixo).filter(Boolean))].length;
    }
    function animateMetrics(){
      ['efetivoTotal','totalFaltas','efetivoPresente','totalViaturas'].forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const val = parseInt(el.textContent)||0;
        let start = 0; const dur = 700; const t0 = performance.now();
        (function step(t){
          const p = Math.min((t-t0)/dur,1);
          el.textContent = Math.floor(p*val);
          if(p<1) requestAnimationFrame(step); else el.textContent = val;
        })(t0);
      });
    }
    function updateTable(data){
      const tbody = document.getElementById('detalhesTableBody'); tbody.innerHTML = '';
      if(!data || data.length===0){
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:#7f8c8d">Nenhum dado encontrado para os filtros selecionados.</td></tr>`;
        return;
      }
      data.forEach(item=>{
        const r = tbody.insertRow();
        r.insertCell().textContent = item.unidade || '-';
        r.insertCell().textContent = item.graduacao || '-';
        r.insertCell().textContent = item.nome || '-';
        r.insertCell().textContent = item.funcao || '-';
        r.insertCell().textContent = item.prefixo || '-';
        r.insertCell().textContent = item.local || '-';
        const sc = r.insertCell();
        const span = document.createElement('span'); span.className = 'status-badge';
        span.textContent = item.status || '-';
        sc.appendChild(span);
      });
    }
    // ---------- CHARTS (Modificado para remover pain√©is) ----------
    function drawChart(id, counts, type, label, colors){
      try{ if(charts[id]) charts[id].destroy();
      }catch(e){}
      const el = document.getElementById(id);
      if(!el) return;
      // Fix keys for display: some keys could include mojibake; ensure fixed
      const labels = Object.keys(counts).map(k=>normalizeKey(k));
      const data  = Object.values(counts);
      const bg = labels.map((_,i)=> colors[i % colors.length]);

      charts[id] = new Chart(el.getContext('2d'), {
        type,
        data: { labels, datasets:[{ label, data, backgroundColor:bg, borderColor:'#fff', borderWidth:1 }] },
        options: {
          responsive:true, maintainAspectRatio:false,
          scales: (type==='bar'||type==='line') ? { y:{ beginAtZero:true, ticks:{ precision:0 } } } : {},
          plugins:{ legend:{ position: (type==='pie'||type==='doughnut')?'right':'top' } }
        }
      });
    }
    function getStatusCounts(data){
      return data.reduce((acc,c)=>{
        const st = c.status || 'OUTROS';
        acc[st] = (acc[st]||0)+1; return acc;
      },{});
    }
    function getCountsByField(data, field){
      return data.reduce((acc,c)=>{ const key = normalizeKey(c[field]||'--'); acc[key] = (acc[key]||0)+1; return acc; }, {});
    }

    function updateCharts(data){
      const statusCounts = getStatusCounts(data);
      const unidadeCounts = getCountsByField(data,'unidade');
      const graduacaoCounts = getCountsByField(data,'graduacao');
      // const funcaoCounts = getCountsByField(data,'funcao'); // REMOVIDO
      // const localCounts = getCountsByField(data,'local'); // REMOVIDO
      // const topLocais = Object.entries(localCounts).sort((a,b)=>b[1]-a[1]).slice(0,10).reduce((acc,[k,v])=>{ acc[k]=v; return acc; }, {}); // REMOVIDO

      drawChart('statusChart', statusCounts, 'doughnut', 'Distribui√ß√£o por Status', ['#4caf50','#ffc107','#c62828','#8e24aa','#607d8b','#ff7043']);
      drawChart('unidadeChart', unidadeCounts, 'bar', 'Efetivo por OPM', ['#0073CF']);
      drawChart('graduacaoChart', graduacaoCounts, 'pie', 'Efetivo por Gradua√ß√£o', ['#003366','#0073CF','#FFC300','#1D6A2E','#C62828','#7EC8E3']);
      // drawChart('funcaoChart', funcaoCounts, 'bar', 'Efetivo por Fun√ß√£o', ['#1D6A2E']); // REMOVIDO
      // drawChart('localChart', topLocais, 'bar', 'Efetivo por Local (TOP 10)', ['#C62828']); // REMOVIDO
      drawChart('faltasChart', getCountsByField(data,'unidade', true), 'bar', 'Faltas por Unidade', ['#FFC300']);
      // faltas por unidade usa unidadeCounts filtered earlier
    }
    // ---------- VIATURAS (N√£o Alterado) ----------
    function calculateViaturaCounts(data){
      return data.reduce((acc,c)=>{
        const p = normalizeKey(c.prefixo||'--');
        if(!p) return acc;
        acc[p] = (acc[p]||0)+1; return acc;
      },{});
    }
    function updateViaturasDisplay(){
      const grid = document.getElementById('viaturasGrid');
      grid.innerHTML = '';
      const topN = parseInt(document.getElementById('topViaturasSelector').value || '8',10);
      const counts = calculateViaturaCounts(fullData);
      const arr = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,topN);
      if(arr.length===0){ grid.innerHTML = '<div class="viatura-card" style="grid-column:1/-1;background:linear-gradient(135deg,#95a5a6,#7f8c8d)"><div style="font-weight:900">Nenhuma viatura</div><div style="font-size:1.6rem;font-weight:900;margin-top:6px">0</div><div style="opacity:.9;font-size:.86rem;margin-top:6px">Policiais na Viatura</div></div>'; return; }
      const colors = ['#00796B','#004D40','#26A69A','#00695C','#00897B','#009688'];
      arr.forEach(( [prefixo,count],i )=>{
        const card = document.createElement('div'); card.className='viatura-card';
        card.style.background = `linear-gradient(135deg, ${colors[i%colors.length]}, ${colors[(i+1)%colors.length]})`;
        card.innerHTML = `<div style="font-weight:900">${prefixo}</div><div style="font-size:1.6rem;font-weight:900;margin-top:6px">${count}</div><div style="opacity:.9;font-size:.86rem;margin-top:6px">Policiais na Viatura</div>`;
        grid.appendChild(card);
      });
    }
    // ---------- file input (N√£o Alterado) ----------
    document.getElementById('fileInput').addEventListener('change', function(e){
      const file = e.target.files[0];
      if(!file) return;
      showLoading(true);
      const reader = new FileReader();
      reader.onload = function(evt){
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type:'array' });
          const first = workbook.SheetNames[0];
          const sheet = workbook.Sheets[first];
          const json = XLSX.utils.sheet_to_json(sheet, { raw:false });
          if(!json || json.length===0) throw new Error('Planilha vazia.');
          processExcelData(json);
        } catch(err){
          console.error(err); showAlert('Erro ao ler arquivo: '+ (err.message||err), 'error'); showLoading(false);
        }
      };
      reader.onerror = function(err){ console.error(err); showAlert('Erro ao ler arquivo.', 'error'); showLoading(false); };
      reader.readAsArrayBuffer(file);
    });
    // ---------- init (Modificado para remover toggle sidebar) ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      updateDateTime(); setInterval(updateDateTime,60000);
      // Otimiza√ß√£o mobile: Sidebar √© sempre vis√≠vel e empilhado. Sem toggle/hamburger.
    });

    // Expose functions to window
    window.filterDashboard = filterDashboard;
    window.resetFilters = resetFilters;
    window.exportar = exportar;
    window.clearData = function(){ fullData=[]; validUnits = new Set(); validGraduacoes = new Set(); validLocais = new Set(); validFuncoes = new Set();
      validViaturas = new Set(); updateFilters(); filterDashboard(); showAlert('üóëÔ∏è Dados limpos','success'); };
    window.updateViaturasDisplay = updateViaturasDisplay;
  </script>
</body>
</html>
